<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shark Route Manager - Setup Wizard</title>
    <style>
        /* Dracula Theme Colors */
        :root {
            --background: #282a36;
            --current-line: #44475a;
            --foreground: #f8f8f2;
            --comment: #6272a4;
            --cyan: #8be9fd;
            --green: #50fa7b;
            --orange: #ffb86c;
            --pink: #ff79c6;
            --purple: #bd93f9;
            --red: #ff5555;
            --yellow: #f1fa8c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: var(--background);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: var(--foreground);
        }

        .container {
            background: var(--current-line);
            border-radius: 10px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            max-width: 900px;
            width: 100%;
            overflow: hidden;
            border: 2px solid var(--purple);
        }

        .header {
            background: var(--background);
            border-bottom: 2px solid var(--purple);
            color: var(--foreground);
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: var(--cyan);
            text-shadow: 0 0 20px rgba(139, 233, 253, 0.5);
        }

        .header p {
            font-size: 1.1em;
            color: var(--purple);
        }

        .content {
            padding: 40px;
            background: var(--background);
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.5em;
            color: var(--pink);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--purple);
        }

        .system-checks {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .check-card {
            background: var(--current-line);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid var(--green);
            transition: transform 0.2s;
        }

        .check-card:hover {
            transform: translateX(5px);
        }

        .check-card.warning {
            border-left-color: var(--yellow);
            background: rgba(241, 250, 140, 0.1);
        }

        .check-card.error {
            border-left-color: var(--red);
            background: rgba(255, 85, 85, 0.1);
        }

        .check-card h3 {
            font-size: 1.1em;
            margin-bottom: 10px;
            color: var(--cyan);
        }

        .check-card p {
            font-size: 0.9em;
            color: var(--comment);
            margin: 5px 0;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-top: 10px;
        }

        .status-badge.success {
            background: rgba(80, 250, 123, 0.2);
            color: var(--green);
            border: 1px solid var(--green);
        }

        .status-badge.warning {
            background: rgba(241, 250, 140, 0.2);
            color: var(--yellow);
            border: 1px solid var(--yellow);
        }

        .status-badge.error {
            background: rgba(255, 85, 85, 0.2);
            color: var(--red);
            border: 1px solid var(--red);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--purple);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--current-line);
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
            background: var(--current-line);
            color: var(--foreground);
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--purple);
            box-shadow: 0 0 10px rgba(189, 147, 249, 0.3);
        }

        .form-group input.valid {
            border-color: var(--green);
        }

        .form-group input.invalid {
            border-color: var(--red);
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: var(--comment);
            font-size: 0.9em;
        }

        .form-group small a {
            color: var(--cyan);
            text-decoration: none;
        }

        .form-group small a:hover {
            text-decoration: underline;
        }

        .form-group .error-message {
            color: var(--red);
            font-size: 0.9em;
            margin-top: 5px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--current-line);
            border-radius: 8px;
            border: 1px solid var(--purple);
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin-bottom: 0;
            color: var(--foreground);
            cursor: pointer;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 30px;
            border: 2px solid transparent;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        .btn-primary {
            background: var(--purple);
            color: var(--background);
            border-color: var(--purple);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(189, 147, 249, 0.5);
            background: var(--pink);
            border-color: var(--pink);
        }

        .btn-secondary {
            background: var(--current-line);
            color: var(--foreground);
            border-color: var(--comment);
        }

        .btn-secondary:hover {
            background: var(--comment);
            border-color: var(--comment);
        }

        .btn-success {
            background: var(--green);
            color: var(--background);
            border-color: var(--green);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(80, 250, 123, 0.5);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-success {
            background: rgba(80, 250, 123, 0.1);
            color: var(--green);
            border-color: var(--green);
        }

        .alert-warning {
            background: rgba(241, 250, 140, 0.1);
            color: var(--yellow);
            border-color: var(--yellow);
        }

        .alert-danger {
            background: rgba(255, 85, 85, 0.1);
            color: var(--red);
            border-color: var(--red);
        }

        .alert-info {
            background: rgba(139, 233, 253, 0.1);
            color: var(--cyan);
            border-color: var(--cyan);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: var(--foreground);
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid var(--current-line);
            border-top: 4px solid var(--purple);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Shark Route Manager</h1>
            <p>Setup Wizard - Configure your reverse proxy in minutes</p>
        </div>

        <div class="content">
            <!-- System Checks Section -->
            <div class="section">
                <h2 class="section-title">System Requirements</h2>
                <div id="system-checks-container" class="system-checks">
                    <div class="loading active">
                        <div class="spinner"></div>
                        <p>Checking system requirements...</p>
                    </div>
                </div>
                <div id="warnings-container"></div>
            </div>

            <!-- Configuration Form -->
            <div class="section">
                <h2 class="section-title">Configuration</h2>
                
                <form id="config-form">
                    <!-- OAuth2 Section -->
                    <div class="form-group">
                        <label for="oauth-client-id">Google OAuth2 Client ID *</label>
                        <input 
                            type="text" 
                            id="oauth-client-id" 
                            placeholder="XXXXXX-XXXXX.apps.googleusercontent.com"
                            required
                        >
                        <small>Get your credentials from <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a></small>
                        <div class="error-message" id="oauth-client-id-error"></div>
                    </div>

                    <div class="form-group">
                        <label for="oauth-client-secret">Google OAuth2 Client Secret *</label>
                        <input 
                            type="password" 
                            id="oauth-client-secret" 
                            placeholder="Your OAuth2 Client Secret"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label for="oauth-cookie-secret">OAuth2 Cookie Secret *</label>
                        <input 
                            type="text" 
                            id="oauth-cookie-secret" 
                            placeholder="Auto-generated secure secret"
                            readonly
                        >
                        <small>Automatically generated - 32 bytes base64 URL-safe</small>
                    </div>

                    <!-- Tailscale Section -->
                    <div class="form-group">
                        <label for="tailscale-hostname">Tailscale Funnel Hostname *</label>
                        <input 
                            type="text" 
                            id="tailscale-hostname" 
                            placeholder="sharky.snowy-burbot.ts.net"
                            required
                        >
                        <small>Your full Tailscale Funnel domain (format: hostname.tailnet.ts.net)</small>
                        <div class="error-message" id="tailscale-hostname-error"></div>
                    </div>

                    <!-- Flask App Section -->
                    <div class="form-group">
                        <label for="flask-secret-key">Flask Secret Key *</label>
                        <input 
                            type="text" 
                            id="flask-secret-key" 
                            placeholder="Auto-generated secure secret"
                            readonly
                        >
                        <small>Automatically generated - 64 hex characters</small>
                    </div>

                    <div class="checkbox-group">
                        <input type="checkbox" id="dev-mode">
                        <label for="dev-mode">
                            <strong>Enable Development Mode</strong>
                            <small style="display: block; font-weight: normal; color: #666;">
                                Bypass OAuth2 authentication for local testing (NOT for production!)
                            </small>
                        </label>
                    </div>

                    <!-- Buttons -->
                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" id="generate-secrets-btn">
                            Generate Secrets
                        </button>
                        <button type="button" class="btn btn-secondary" id="load-config-btn">
                            Load Existing Config
                        </button>
                        <button type="submit" class="btn btn-primary" id="save-config-btn">
                            Save Configuration
                        </button>
                    </div>
                </form>

                <div id="save-result" class="hidden"></div>
            </div>

            <!-- Docker Controls -->
            <div class="section">
                <h2 class="section-title">Docker Controls</h2>
                <p style="margin-bottom: 20px; color: #666;">
                    Start or stop the Docker containers after configuration is complete.
                </p>
                <div class="button-group">
                    <button type="button" class="btn btn-success" id="docker-start-btn">
                        Start Docker Containers
                    </button>
                    <button type="button" class="btn btn-secondary" id="docker-stop-btn">
                        Stop Docker Containers
                    </button>
                </div>
                <div id="docker-result" class="hidden"></div>
            </div>
        </div>
    </div>

    <script>
        // API helpers
        async function apiRequest(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            const response = await fetch(endpoint, options);
            return await response.json();
        }

        // System checks
        async function runSystemChecks() {
            const container = document.getElementById('system-checks-container');
            const warningsContainer = document.getElementById('warnings-container');
            
            try {
                const checks = await apiRequest('/api/system-check');
                
                container.innerHTML = '';
                let warnings = [];
                
                // Python check
                const pythonCard = createCheckCard(
                    'Python',
                    checks.python.compatible ? 'success' : 'error',
                    `Version: ${checks.python.version}`,
                    checks.python.compatible ? 'Compatible' : 'Incompatible (Need 3.8+)'
                );
                container.appendChild(pythonCard);
                
                // Admin check
                const adminCard = createCheckCard(
                    'Privileges',
                    checks.is_admin ? 'success' : 'warning',
                    `Running as: ${checks.is_admin ? 'Admin/Sudo' : 'Normal User'}`,
                    checks.is_admin ? 'Elevated' : 'Limited'
                );
                container.appendChild(adminCard);
                if (!checks.is_admin) {
                    warnings.push('Not running with admin/sudo privileges - Docker and Tailscale commands may fail');
                }
                
                // Docker check
                const dockerCard = createCheckCard(
                    'Docker',
                    checks.docker.installed && checks.docker.running ? 'success' : 'error',
                    checks.docker.installed ? `${checks.docker.version}` : 'Not installed',
                    checks.docker.running ? 'Running' : checks.docker.installed ? 'Not Running' : 'Not Found'
                );
                container.appendChild(dockerCard);
                if (!checks.docker.installed) {
                    warnings.push('Docker is not installed - Install from https://docker.com');
                } else if (!checks.docker.running) {
                    warnings.push('Docker is not running - Please start Docker Desktop');
                }
                
                // Docker Compose check
                const composeCard = createCheckCard(
                    'Docker Compose',
                    checks.docker_compose.installed ? 'success' : 'warning',
                    checks.docker_compose.installed ? `${checks.docker_compose.version}` : 'Not installed',
                    checks.docker_compose.installed ? 'Installed' : 'Not Found'
                );
                container.appendChild(composeCard);
                
                // Tailscale check
                const tailscaleCard = createCheckCard(
                    'Tailscale',
                    checks.tailscale.installed && checks.tailscale.running ? 'success' : 'warning',
                    checks.tailscale.installed ? `${checks.tailscale.version}` : 'Not installed',
                    checks.tailscale.running ? 'Running' : checks.tailscale.installed ? 'Not Running' : 'Not Found'
                );
                container.appendChild(tailscaleCard);
                if (!checks.tailscale.installed) {
                    warnings.push('Tailscale is not installed - Install from https://tailscale.com');
                } else if (!checks.tailscale.running) {
                    warnings.push('Tailscale is not running - Please start Tailscale');
                }
                
                // Display warnings
                if (warnings.length > 0) {
                    warningsContainer.innerHTML = `
                        <div class="alert alert-warning">
                            <strong>Warnings:</strong>
                            <ul style="margin: 10px 0 0 20px;">
                                ${warnings.map(w => `<li>${w}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                } else {
                    warningsContainer.innerHTML = `
                        <div class="alert alert-success">
                            <strong>All system checks passed!</strong> Your system is ready for setup.
                        </div>
                    `;
                }
                
            } catch (error) {
                container.innerHTML = `<div class="alert alert-danger">Error checking system: ${error.message}</div>`;
            }
        }

        function createCheckCard(title, status, info, statusText) {
            const card = document.createElement('div');
            card.className = `check-card ${status === 'success' ? '' : status}`;
            card.innerHTML = `
                <h3>${title}</h3>
                <p>${info}</p>
                <span class="status-badge ${status}">${statusText}</span>
            `;
            return card;
        }

        // Generate secrets
        document.getElementById('generate-secrets-btn').addEventListener('click', async () => {
            try {
                const secrets = await apiRequest('/api/generate-secrets', 'POST');
                document.getElementById('oauth-cookie-secret').value = secrets.oauth_cookie_secret;
                document.getElementById('flask-secret-key').value = secrets.flask_secret_key;
                
                showAlert('save-result', 'Secrets generated successfully!', 'success');
            } catch (error) {
                showAlert('save-result', `Error generating secrets: ${error.message}`, 'danger');
            }
        });

        // Load existing config
        document.getElementById('load-config-btn').addEventListener('click', async () => {
            try {
                const config = await apiRequest('/api/load-config');
                
                if (config.OAUTH2_PROXY_CLIENT_ID) {
                    document.getElementById('oauth-client-id').value = config.OAUTH2_PROXY_CLIENT_ID;
                }
                if (config.OAUTH2_PROXY_CLIENT_SECRET) {
                    document.getElementById('oauth-client-secret').value = config.OAUTH2_PROXY_CLIENT_SECRET;
                }
                if (config.OAUTH2_PROXY_COOKIE_SECRET) {
                    document.getElementById('oauth-cookie-secret').value = config.OAUTH2_PROXY_COOKIE_SECRET;
                }
                if (config.FUNNEL_HOSTNAME) {
                    document.getElementById('tailscale-hostname').value = config.FUNNEL_HOSTNAME;
                }
                if (config.SECRET_KEY) {
                    document.getElementById('flask-secret-key').value = config.SECRET_KEY;
                }
                if (config.DEV_MODE === 'true') {
                    document.getElementById('dev-mode').checked = true;
                }
                
                showAlert('save-result', 'Existing configuration loaded!', 'info');
            } catch (error) {
                showAlert('save-result', `Error loading config: ${error.message}`, 'danger');
            }
        });

        // Validate OAuth Client ID
        document.getElementById('oauth-client-id').addEventListener('blur', async (e) => {
            const value = e.target.value;
            if (!value) return;
            
            try {
                const result = await apiRequest('/api/validate-oauth', 'POST', { client_id: value });
                const errorDiv = document.getElementById('oauth-client-id-error');
                
                if (result.valid) {
                    e.target.classList.remove('invalid');
                    e.target.classList.add('valid');
                    errorDiv.textContent = '';
                } else {
                    e.target.classList.remove('valid');
                    e.target.classList.add('invalid');
                    errorDiv.textContent = result.message;
                }
            } catch (error) {
                console.error('Validation error:', error);
            }
        });

        // Validate Tailscale hostname
        document.getElementById('tailscale-hostname').addEventListener('blur', async (e) => {
            const value = e.target.value;
            if (!value) return;
            
            try {
                const result = await apiRequest('/api/validate-tailscale', 'POST', { hostname: value });
                const errorDiv = document.getElementById('tailscale-hostname-error');
                
                if (result.valid) {
                    e.target.classList.remove('invalid');
                    e.target.classList.add('valid');
                    errorDiv.textContent = '';
                } else {
                    e.target.classList.remove('valid');
                    e.target.classList.add('invalid');
                    errorDiv.textContent = result.message;
                }
            } catch (error) {
                console.error('Validation error:', error);
            }
        });

        // Save configuration
        document.getElementById('config-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const devMode = document.getElementById('dev-mode').checked;
            
            const config = {
                oauth_client_id: document.getElementById('oauth-client-id').value,
                oauth_client_secret: document.getElementById('oauth-client-secret').value,
                oauth_cookie_secret: document.getElementById('oauth-cookie-secret').value,
                tailscale_hostname: document.getElementById('tailscale-hostname').value,
                flask_secret_key: document.getElementById('flask-secret-key').value,
                dev_mode: devMode ? 'true' : 'false',
                flask_env: devMode ? 'development' : 'production',
                debug: devMode ? 'true' : 'false'
            };
            
            try {
                const result = await apiRequest('/api/save-config', 'POST', config);
                showAlert('save-result', result.message, 'success');
            } catch (error) {
                showAlert('save-result', `Error saving configuration: ${error.message}`, 'danger');
            }
        });

        // Docker start
        document.getElementById('docker-start-btn').addEventListener('click', async () => {
            const btn = document.getElementById('docker-start-btn');
            btn.disabled = true;
            btn.textContent = 'Starting...';
            
            try {
                const result = await apiRequest('/api/docker/start', 'POST');
                showAlert('docker-result', result.message, 'success');
            } catch (error) {
                const errorData = await error;
                showAlert('docker-result', errorData.message || 'Error starting Docker', 'danger');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Start Docker Containers';
            }
        });

        // Docker stop
        document.getElementById('docker-stop-btn').addEventListener('click', async () => {
            const btn = document.getElementById('docker-stop-btn');
            btn.disabled = true;
            btn.textContent = 'Stopping...';
            
            try {
                const result = await apiRequest('/api/docker/stop', 'POST');
                showAlert('docker-result', result.message, 'success');
            } catch (error) {
                const errorData = await error;
                showAlert('docker-result', errorData.message || 'Error stopping Docker', 'danger');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Stop Docker Containers';
            }
        });

        // Helper to show alerts
        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.className = `alert alert-${type}`;
            container.textContent = message;
            container.classList.remove('hidden');
            
            setTimeout(() => {
                container.classList.add('hidden');
            }, 5000);
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            runSystemChecks();
            
            // Auto-generate secrets on load
            apiRequest('/api/generate-secrets', 'POST').then(secrets => {
                document.getElementById('oauth-cookie-secret').value = secrets.oauth_cookie_secret;
                document.getElementById('flask-secret-key').value = secrets.flask_secret_key;
            });
        });
    </script>
</body>
</html>
